name: Build Agent Binaries

on:
  push:
    branches: [master]
    tags: ['v*']
  workflow_dispatch:

permissions:
  contents: write   # needed for creating releases
  packages: read

jobs:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Native Linux x86_64 build — runs directly on the host
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  build-linux-x86:
    runs-on: [self-hosted, actions-screencontrol]
    steps:
      - name: Install Git LFS
        run: |
          if ! command -v git-lfs &>/dev/null; then
            curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
            sudo apt-get install -y git-lfs
          fi
          git lfs install

      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install system dependencies
        run: |
          # Clean up stale arm64 architecture from previous CI runs
          sudo dpkg --remove-architecture arm64 2>/dev/null || true
          sudo apt-get update
          sudo apt-get install -y \
            protobuf-compiler pkg-config \
            libgtk-3-dev libwebkit2gtk-4.1-dev \
            libssl-dev libglib2.0-dev \
            libayatana-appindicator3-dev

      - name: Install Rust target
        run: rustup target add x86_64-unknown-linux-gnu

      - name: Clean stale Cargo config
        run: rm -f ~/.cargo/config.toml

      - name: Build sc-agent (Linux x86_64)
        run: |
          cargo build --manifest-path server/Cargo.toml \
            --package sc-agent --release --target x86_64-unknown-linux-gnu

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: sc-agent-linux-x86_64
          path: server/target/x86_64-unknown-linux-gnu/release/sc-agent
          retention-days: 1

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Linux aarch64 build — uses `cross` (Docker-based) with its own
  # target directory to avoid GLIBC mismatch with the host.
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  build-linux-arm:
    runs-on: [self-hosted, actions-screencontrol]
    steps:
      - name: Install Git LFS
        run: |
          if ! command -v git-lfs &>/dev/null; then
            curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
            sudo apt-get install -y git-lfs
          fi
          git lfs install

      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install cross
        run: |
          if ! command -v cross &>/dev/null; then
            cargo install cross --git https://github.com/cross-rs/cross
          fi

      - name: Install Rust target
        run: rustup target add aarch64-unknown-linux-gnu

      - name: Clean stale state
        run: |
          # Remove stale cargo config from other parallel jobs
          rm -f ~/.cargo/config.toml
          # cross needs a clean target dir to avoid GLIBC mismatch
          rm -rf server/target/aarch64-unknown-linux-gnu

      - name: Build sc-agent (Linux aarch64)
        working-directory: server
        run: |
          cross build --package sc-agent --release \
            --target aarch64-unknown-linux-gnu

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: sc-agent-linux-aarch64
          path: server/target/aarch64-unknown-linux-gnu/release/sc-agent
          retention-days: 1

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # macOS builds — uses osxcross toolchain for cross-compilation
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  build-macos:
    runs-on: [self-hosted, actions-screencontrol]
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            artifact: sc-agent-macos-x86_64
          - target: aarch64-apple-darwin
            artifact: sc-agent-macos-aarch64

    env:
      OSXCROSS_ROOT: /tmp/osxcross

    steps:
      - name: Install Git LFS
        run: |
          if ! command -v git-lfs &>/dev/null; then
            curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
            sudo apt-get install -y git-lfs
          fi
          git lfs install

      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install system dependencies
        run: |
          # Clean up stale arm64 architecture from previous CI runs
          sudo dpkg --remove-architecture arm64 2>/dev/null || true
          sudo apt-get update
          sudo apt-get install -y \
            protobuf-compiler pkg-config \
            clang llvm-dev libxml2-dev uuid-dev \
            libssl-dev bash patch make tar xz-utils \
            bzip2 gzip cpio libbz2-dev zlib1g-dev cmake

      - name: Install Rust target
        run: rustup target add ${{ matrix.target }}

      # ── osxcross setup ─────────────────────────────────
      - name: Cache osxcross toolchain
        id: osxcross-cache
        uses: actions/cache@v4
        with:
          path: /tmp/osxcross
          key: osxcross-${{ hashFiles('sdk/MacOSX*') }}

      - name: Build osxcross from bundled SDK
        if: steps.osxcross-cache.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          rm -rf /tmp/osxcross-src

          echo "━━━ Contents of sdk/ ━━━"
          ls -lh sdk/ || true

          # Verify the SDK tarball is real data (not an LFS pointer)
          for f in sdk/MacOSX*.sdk.tar.*; do
            if [ -f "$f" ]; then
              SIZE=$(stat -c%s "$f" 2>/dev/null || stat -f%z "$f")
              echo "  $f: $SIZE bytes"
              if [ "$SIZE" -lt 1000000 ]; then
                echo "  ⚠️  File too small — likely an LFS pointer. Pulling..."
                git lfs pull
              fi
            fi
          done

          SDK_TARBALLS=$(find sdk/ -maxdepth 1 -name 'MacOSX*.sdk.tar.*' -size +1M 2>/dev/null || true)
          if [ -z "$SDK_TARBALLS" ]; then
            echo "❌ No valid MacOSX SDK tarballs found in sdk/"
            exit 1
          fi
          echo "━━━ Building osxcross with: ━━━"
          echo "$SDK_TARBALLS"

          git clone --depth=1 https://github.com/tpoechtrager/osxcross.git /tmp/osxcross-src

          for tarball in $SDK_TARBALLS; do
            cp "$tarball" /tmp/osxcross-src/tarballs/
            echo "  → copied $(basename "$tarball")"
          done

          cd /tmp/osxcross-src
          UNATTENDED=1 ./build.sh

          mkdir -p "$OSXCROSS_ROOT"
          cp -r /tmp/osxcross-src/target/* "$OSXCROSS_ROOT/"
          rm -rf /tmp/osxcross-src

          echo "✅ osxcross built successfully"
          ls "$OSXCROSS_ROOT/bin/" | head -20

      - name: Configure Cargo cross-linker
        run: |
          mkdir -p ~/.cargo

          # Find the clang/ar wrappers for this target's arch
          ARCH=$(echo "${{ matrix.target }}" | cut -d- -f1)
          CLANG=$(ls "$OSXCROSS_ROOT/bin/" | grep "${ARCH}-apple-darwin.*-clang$" | head -1)
          AR=$(ls "$OSXCROSS_ROOT/bin/" | grep "${ARCH}-apple-darwin.*-ar$" | head -1)

          if [ -z "$CLANG" ] || [ -z "$AR" ]; then
            echo "❌ Could not find osxcross wrappers for $ARCH"
            ls "$OSXCROSS_ROOT/bin/"
            exit 1
          fi

          # Write a FRESH cargo config (overwrite to avoid duplicates from parallel jobs)
          cat > ~/.cargo/config.toml << TOML
          [target.${{ matrix.target }}]
          linker = "${OSXCROSS_ROOT}/bin/${CLANG}"
          ar = "${OSXCROSS_ROOT}/bin/${AR}"
          TOML

          echo "✅ Cargo config for ${{ matrix.target }}:"
          cat ~/.cargo/config.toml

      - name: Build sc-agent (${{ matrix.target }})
        env:
          # Tell pkg-config to not look for libs (macOS deps are in the SDK)
          PKG_CONFIG_ALLOW_CROSS: 1
        run: |
          export PATH="/tmp/osxcross/bin:$PATH"

          # Point cc-rs at osxcross clang for the macOS *target* only.
          # Using target-specific CC_<target> vars so we don't leak osxcross
          # into build scripts that compile for the *host* (e.g. ring).
          ARCH=$(echo "${{ matrix.target }}" | cut -d- -f1)
          CLANG=$(ls "$OSXCROSS_ROOT/bin/" | grep "${ARCH}-apple-darwin.*-clang$" | head -1)
          AR_BIN=$(ls "$OSXCROSS_ROOT/bin/" | grep "${ARCH}-apple-darwin.*-ar$" | head -1)

          # Convert target triple to env-var format: x86_64-apple-darwin -> x86_64_apple_darwin
          TARGET_ENV=$(echo "${{ matrix.target }}" | tr '-' '_')
          export "CC_${TARGET_ENV}=${OSXCROSS_ROOT}/bin/${CLANG}"
          export "AR_${TARGET_ENV}=${OSXCROSS_ROOT}/bin/${AR_BIN}"

          cargo build --manifest-path server/Cargo.toml \
            --package sc-agent --release --target ${{ matrix.target }}

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: server/target/${{ matrix.target }}/release/sc-agent
          retention-days: 1

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Windows x86_64 build — uses mingw-w64 cross-compiler
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  build-windows:
    runs-on: [self-hosted, actions-screencontrol]
    steps:
      - name: Install Git LFS
        run: |
          if ! command -v git-lfs &>/dev/null; then
            curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
            sudo apt-get install -y git-lfs
          fi
          git lfs install

      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install system dependencies
        run: |
          # Clean up stale arm64 architecture from previous CI runs
          sudo dpkg --remove-architecture arm64 2>/dev/null || true
          sudo apt-get update
          sudo apt-get install -y \
            protobuf-compiler pkg-config \
            gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64

      - name: Install Rust target
        run: rustup target add x86_64-pc-windows-gnu

      - name: Configure Cargo linker
        run: |
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << 'TOML'
          [target.x86_64-pc-windows-gnu]
          linker = "x86_64-w64-mingw32-gcc"
          TOML

      - name: Build sc-agent (Windows x86_64)
        run: |
          cargo build --manifest-path server/Cargo.toml \
            --package sc-agent --release --target x86_64-pc-windows-gnu

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: sc-agent-windows-x86_64
          path: server/target/x86_64-pc-windows-gnu/release/sc-agent.exe
          retention-days: 1

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Collect all binaries and publish
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  collect:
    runs-on: [self-hosted, actions-screencontrol]
    needs: [build-linux-x86, build-linux-arm, build-macos, build-windows]
    if: always()

    steps:
      - name: Checkout (for version info)
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Collect and rename binaries
        run: |
          mkdir -p server/agent-builds

          declare -A TARGETS=(
            ["sc-agent-linux-x86_64"]="sc-agent-linux-x86_64"
            ["sc-agent-linux-aarch64"]="sc-agent-linux-aarch64"
            ["sc-agent-macos-x86_64"]="sc-agent-macos-x86_64"
            ["sc-agent-macos-aarch64"]="sc-agent-macos-aarch64"
            ["sc-agent-windows-x86_64"]="sc-agent-windows-x86_64.exe"
          )

          for artifact_name in "${!TARGETS[@]}"; do
            output="${TARGETS[$artifact_name]}"
            # Find the binary in the downloaded artifact directory
            src_dir="artifacts/$artifact_name"
            if [ -d "$src_dir" ]; then
              # Find the actual binary (may be sc-agent or sc-agent.exe)
              bin=$(find "$src_dir" -type f \( -name "sc-agent" -o -name "sc-agent.exe" \) | head -1)
              if [ -n "$bin" ]; then
                cp "$bin" "server/agent-builds/$output"
                chmod +x "server/agent-builds/$output" 2>/dev/null || true
                SIZE=$(stat -c%s "server/agent-builds/$output" 2>/dev/null || stat -f%z "server/agent-builds/$output")
                echo "✅ $output ($SIZE bytes)"
              else
                echo "⚠️  No sc-agent binary found in $src_dir"
              fi
            else
              echo "⚠️  Artifact $artifact_name not available (build may have failed)"
            fi
          done

          echo ""
          echo "━━━ Final agent-builds/ contents: ━━━"
          ls -lh server/agent-builds/

      - name: Generate manifest.json
        run: |
          python3 - server/agent-builds << 'PYEOF'
          import json, os, sys, hashlib

          build_dir = sys.argv[1]

          # Read version from workspace Cargo.toml
          version = "0.1.0"
          with open("server/Cargo.toml") as f:
              in_pkg = False
              for line in f:
                  if "[workspace.package]" in line:
                      in_pkg = True
                  elif in_pkg and line.strip().startswith("version"):
                      version = line.split('"')[1]
                      break

          from datetime import datetime, timezone
          built_at = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")

          builds = {}
          for f in sorted(os.listdir(build_dir)):
              if not f.startswith("sc-agent-"):
                  continue
              path = os.path.join(build_dir, f)
              if not os.path.isfile(path):
                  continue
              sha = hashlib.sha256(open(path, "rb").read()).hexdigest()
              size = os.path.getsize(path)
              key = f.replace("sc-agent-", "").replace(".exe", "")
              builds[key] = {"file": f, "sha256": sha, "size": size}

          manifest = {
              "version": version,
              "built_at": built_at,
              "builds": builds,
              "release_notes": "",
              "mandatory": False,
          }

          out = os.path.join(build_dir, "manifest.json")
          with open(out, "w") as fh:
              json.dump(manifest, fh, indent=2)
              fh.write("\n")
          print(f"✅ manifest.json: {len(builds)} build(s)")
          for k, v in builds.items():
              print(f"   {k}: {v['file']} ({v['size']} bytes)")
          PYEOF

      - name: Upload combined agent builds
        uses: actions/upload-artifact@v4
        with:
          name: agent-builds
          path: server/agent-builds/
          retention-days: 30

      # ── GitHub Release (on tag push only) ─────────────
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            server/agent-builds/sc-agent-*
            server/agent-builds/manifest.json
          generate_release_notes: true
