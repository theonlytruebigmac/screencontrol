name: Build Agent Binaries

on:
  push:
    branches: [master]
    tags: ['v*']
  workflow_dispatch:

permissions:
  contents: write   # needed for creating releases
  packages: read

jobs:
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Native Linux x86_64 build — runs directly on the host
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  build-linux-x86:
    runs-on: [self-hosted, actions-screencontrol]
    steps:
      - name: Install Git LFS
        run: |
          if ! command -v git-lfs &>/dev/null; then
            curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
            sudo apt-get install -y git-lfs
          fi
          git lfs install

      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install system dependencies
        run: |
          # Clean up stale arm64 architecture from previous CI runs
          sudo dpkg --remove-architecture arm64 2>/dev/null || true
          sudo apt-get update
          sudo apt-get install -y \
            protobuf-compiler pkg-config \
            libgtk-3-dev libwebkit2gtk-4.1-dev \
            libssl-dev libglib2.0-dev \
            libayatana-appindicator3-dev

      - name: Install Rust target
        run: rustup target add x86_64-unknown-linux-gnu

      - name: Clean stale Cargo config
        run: rm -f ~/.cargo/config.toml

      - name: Build sc-agent (Linux x86_64)
        run: |
          cargo build --manifest-path server/Cargo.toml \
            --package sc-agent --release --target x86_64-unknown-linux-gnu

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: sc-agent-linux-x86_64
          path: server/target/x86_64-unknown-linux-gnu/release/sc-agent
          retention-days: 1

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Linux aarch64 build — Docker-native cross-compilation.
  # Uses a self-contained Ubuntu 22.04 image with Rust installed
  # inside (avoids glibc mismatch between host and container).
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  build-linux-arm:
    runs-on: [self-hosted, actions-screencontrol]
    steps:
      - name: Install Git LFS
        run: |
          if ! command -v git-lfs &>/dev/null; then
            curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
            sudo apt-get install -y git-lfs
          fi
          git lfs install

      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Build Docker cross-compilation image
        run: |
          docker build -t sc-agent-arm64-builder \
            -f server/cross/aarch64-unknown-linux-gnu.Dockerfile \
            server/cross/

      - name: Build sc-agent (Linux aarch64)
        run: |
          # Clean up any previous build volume
          docker volume rm sc-agent-arm64-build 2>/dev/null || true
          # Build inside Docker with source mounted read-only.
          # Named volume persists the cargo target dir for extraction.
          docker run --rm \
            -v "${{ github.workspace }}:/src:ro" \
            -v sc-agent-arm64-cargo-cache:/root/.cargo/registry \
            -v sc-agent-arm64-build:/build \
            -w /build \
            sc-agent-arm64-builder \
            bash -c '
              cp -r /src/server/. . &&
              mkdir -p proto && cp -r /src/proto/. proto/ &&
              cargo build --package sc-agent --release \
                --target aarch64-unknown-linux-gnu
            '
          # Extract binary from the named volume
          docker run --rm \
            -v sc-agent-arm64-build:/build:ro \
            -v "${{ github.workspace }}:/out" \
            ubuntu:22.04 \
            cp /build/target/aarch64-unknown-linux-gnu/release/sc-agent \
               /out/sc-agent-linux-aarch64

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: sc-agent-linux-aarch64
          path: sc-agent-linux-aarch64
          retention-days: 1

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # macOS builds — native compilation on self-hosted Apple Silicon runner.
  # aarch64 compiles natively, x86_64 cross-compiles via Rust.
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  build-macos:
    runs-on: [self-hosted, macOS, ARM64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Rust targets
        run: |
          rustup target add x86_64-apple-darwin aarch64-apple-darwin

      - name: Install system dependencies
        run: |
          brew install protobuf pkg-config opus 2>/dev/null || true

      - name: Build sc-agent (x86_64-apple-darwin)
        run: |
          cargo build --manifest-path server/Cargo.toml \
            --package sc-agent --release --target x86_64-apple-darwin \
            --no-default-features

      - name: Build sc-agent (aarch64-apple-darwin)
        run: |
          cargo build --manifest-path server/Cargo.toml \
            --package sc-agent --release --target aarch64-apple-darwin

      - name: Upload x86_64 binary
        uses: actions/upload-artifact@v4
        with:
          name: sc-agent-macos-x86_64
          path: server/target/x86_64-apple-darwin/release/sc-agent
          retention-days: 1

      - name: Upload aarch64 binary
        uses: actions/upload-artifact@v4
        with:
          name: sc-agent-macos-aarch64
          path: server/target/aarch64-apple-darwin/release/sc-agent
          retention-days: 1

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Windows x86_64 build — uses mingw-w64 cross-compiler
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  build-windows:
    runs-on: [self-hosted, actions-screencontrol]
    steps:
      - name: Install Git LFS
        run: |
          if ! command -v git-lfs &>/dev/null; then
            curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
            sudo apt-get install -y git-lfs
          fi
          git lfs install

      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install system dependencies
        run: |
          # Clean up stale arm64 architecture from previous CI runs
          sudo dpkg --remove-architecture arm64 2>/dev/null || true
          sudo apt-get update
          sudo apt-get install -y \
            protobuf-compiler pkg-config \
            gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64

      - name: Install Rust target
        run: rustup target add x86_64-pc-windows-gnu

      - name: Configure Cargo linker
        run: |
          mkdir -p ~/.cargo
          cat > ~/.cargo/config.toml << 'TOML'
          [target.x86_64-pc-windows-gnu]
          linker = "x86_64-w64-mingw32-gcc"
          TOML

      - name: Build sc-agent (Windows x86_64)
        run: |
          cargo build --manifest-path server/Cargo.toml \
            --package sc-agent --release --target x86_64-pc-windows-gnu

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: sc-agent-windows-x86_64
          path: server/target/x86_64-pc-windows-gnu/release/sc-agent.exe
          retention-days: 1

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Collect all binaries and publish
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  collect:
    runs-on: [self-hosted, actions-screencontrol]
    needs: [build-linux-x86, build-linux-arm, build-macos, build-windows]
    if: always()

    steps:
      - name: Checkout (for version info)
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Collect and rename binaries
        run: |
          mkdir -p server/agent-builds

          declare -A TARGETS=(
            ["sc-agent-linux-x86_64"]="sc-agent-linux-x86_64"
            ["sc-agent-linux-aarch64"]="sc-agent-linux-aarch64"
            ["sc-agent-macos-x86_64"]="sc-agent-macos-x86_64"
            ["sc-agent-macos-aarch64"]="sc-agent-macos-aarch64"
            ["sc-agent-windows-x86_64"]="sc-agent-windows-x86_64.exe"
          )

          for artifact_name in "${!TARGETS[@]}"; do
            output="${TARGETS[$artifact_name]}"
            # Find the binary in the downloaded artifact directory
            src_dir="artifacts/$artifact_name"
            if [ -d "$src_dir" ]; then
              # Find the actual binary (may be sc-agent or sc-agent.exe)
              bin=$(find "$src_dir" -type f \( -name "sc-agent" -o -name "sc-agent.exe" \) | head -1)
              if [ -n "$bin" ]; then
                cp "$bin" "server/agent-builds/$output"
                chmod +x "server/agent-builds/$output" 2>/dev/null || true
                SIZE=$(stat -c%s "server/agent-builds/$output" 2>/dev/null || stat -f%z "server/agent-builds/$output")
                echo "✅ $output ($SIZE bytes)"
              else
                echo "⚠️  No sc-agent binary found in $src_dir"
              fi
            else
              echo "⚠️  Artifact $artifact_name not available (build may have failed)"
            fi
          done

          echo ""
          echo "━━━ Final agent-builds/ contents: ━━━"
          ls -lh server/agent-builds/

      - name: Generate manifest.json
        run: |
          python3 - server/agent-builds << 'PYEOF'
          import json, os, sys, hashlib

          build_dir = sys.argv[1]

          # Read version from workspace Cargo.toml
          version = "0.1.0"
          with open("server/Cargo.toml") as f:
              in_pkg = False
              for line in f:
                  if "[workspace.package]" in line:
                      in_pkg = True
                  elif in_pkg and line.strip().startswith("version"):
                      version = line.split('"')[1]
                      break

          from datetime import datetime, timezone
          built_at = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")

          builds = {}
          for f in sorted(os.listdir(build_dir)):
              if not f.startswith("sc-agent-"):
                  continue
              path = os.path.join(build_dir, f)
              if not os.path.isfile(path):
                  continue
              sha = hashlib.sha256(open(path, "rb").read()).hexdigest()
              size = os.path.getsize(path)
              key = f.replace("sc-agent-", "").replace(".exe", "")
              builds[key] = {"file": f, "sha256": sha, "size": size}

          manifest = {
              "version": version,
              "built_at": built_at,
              "builds": builds,
              "release_notes": "",
              "mandatory": False,
          }

          out = os.path.join(build_dir, "manifest.json")
          with open(out, "w") as fh:
              json.dump(manifest, fh, indent=2)
              fh.write("\n")
          print(f"✅ manifest.json: {len(builds)} build(s)")
          for k, v in builds.items():
              print(f"   {k}: {v['file']} ({v['size']} bytes)")
          PYEOF

      - name: Upload combined agent builds
        uses: actions/upload-artifact@v4
        with:
          name: agent-builds
          path: server/agent-builds/
          retention-days: 30

      # ── GitHub Release (on tag push only) ─────────────
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            server/agent-builds/sc-agent-*
            server/agent-builds/manifest.json
          generate_release_notes: true
